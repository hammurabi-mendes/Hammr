#!/bin/sh

BASEDIR=`pwd`
RUNNINGDIR=$(pwd)

REGISTRYLOC=localhost
HDFSURI="hdfs://$REGISTRYLOC:9000"

COMMONDIR="$BASEDIR/Common/bin/"
LIBDIR="$BASEDIR/lib/"


JGRAPHFILE="$LIBDIR/jgrapht-jdk1.6.jar"
HADOOPJAR="$LIBDIR/hadoop-core-0.20.2-cdh3u1.jar"
COMMONLOGGINGJAR="$LIBDIR/commons-logging-1.1.1.jar"

BINDIRS=$COMMONDIR:$BASEDIR/Client/bin:$BASEDIR/Launcher/bin:$BASEDIR/Manager/bin

# We are memory hungry! Reserve heap space for the JVM
HEAPPARAMS="-XX:-UseGCOverheadLimit -Xms2500M -Xmx2500M"

export CODEBASE="file://${BASEDIR}/Common/bin/"

export CLASSPATH=$BINDIRS:$JGRAPHFILE:$HADOOPJAR:$COMMONLOGGINGJAR

Compile() {
	ant -buildfile $BASEDIR/Common/build.xml   && \
	ant -buildfile $BASEDIR/Client/build.xml   && \
	ant -buildfile $BASEDIR/Manager/build.xml  && \
	ant -buildfile $BASEDIR/Launcher/build.xml && \
	jar xf $JGRAPHFILE && rm -r META-INF && mv org $COMMONDIR
}

Clean() {
	ant -buildfile $BASEDIR/Common/build.xml clean
	ant -buildfile $BASEDIR/Client/build.xml clean
	ant -buildfile $BASEDIR/Manager/build.xml clean
	ant -buildfile $BASEDIR/Launcher/build.xml clean
}

CheckRMIRegistry() {
	if ps ax | grep rmiregistry | grep -v grep > /dev/null
	then
		echo "Registry running -> continuing"
	else
		echo "Registry not running -> giving up"
		exit
	fi
}

RunManager() {
	CheckRMIRegistry

	echo "Running manager: codebase=${CODEBASE} and registry=${REGISTRYLOC}"
	echo "You should have alredy run \"rmiregistry\" on machine ${REGISTRYLOC}"
	$BASEDIR/scripts/start_manager.sh --hammr_home $BASEDIR --master_host localhost
}

RunLauncher() {
	echo "Running launcher: codebase=${CODEBASE} and registry=${REGISTRYLOC}"
    $BASEDIR/scripts/start_launcher.sh --hammr_home $BASEDIR --master_host localhost
}

RunClient() {
	echo "Running client: codebase=${CODEBASE} and registry=${REGISTRYLOC}"
	java -cp $CLASSPATH $HEAPPARAMS -Djava.rmi.server.codebase=$CODEBASE -Djava.security.policy=$BASEDIR/Client/security.policy client.Client $REGISTRYLOC $RUNNINGDIR $@ &
}

RunGenInput() {
	echo "Running the input generator"
	java -cp $CLASSPATH $HEAPPARAMS utilities.counting.CountingInputGenerator $@
}

RunGenOutput() {
	echo "Running the output extractor"
	java -cp $CLASSPATH $HEAPPARAMS utilities.counting.CountingOutputExtractor $@
}

RunProgram() {
    java -cp $CLASSPATH $HEAPPARAMS -Djava.security.policy=$BASEDIR/Client/security.policy -Dhammr.hdfs.uri=$HDFSURI -Djava.rmi.server.codebase=$CODEBASE -Djava.rmi.server.location=$REGISTRYLOC $@;
}

Kill() {
	ps ax -o pid= | grep ConcreteManager | grep -v grep | xargs kill -9 2>/dev/null
	ps ax -o pid= | grep ConcreteLauncher | grep -v grep | xargs kill -9 2>/dev/null
    $BASEDIR/scripts/stop_manager.sh --hammr_home $BASEDIR
    $BASEDIR/scripts/stop_launcher.sh --hammr_home $BASEDIR
}

COMMAND=$1; shift;

case "${COMMAND}" in
    classpath)    echo $CLASSPATH ;;
    compile)      Compile $@ ;;
    clean)        Clean $@ ;;
    manager)      RunManager $@ ;;
    launcher)     RunLauncher $@ ;;
    client)       RunClient $@ ;;
		gen_input)    RunGenInput $@ ;;
		gen_output)   RunGenOutput $@ ;;
    kill)         Kill $@ ;;
    run)          RunProgram $@ ;;
    *)            echo "Unrecognized command"; exit 1; ;;
esac

exit 0
