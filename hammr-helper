#!/bin/sh

BASEDIR=`pwd`

REGISTRYLOC=localhost

JGRAPHFILE=jgrapht-jdk1.6.jar

BINDIRS=$BASEDIR/Client/bin:$BASEDIR/Common/bin:$BASEDIR/Launcher/bin:$BASEDIR/Manager/bin
LIBDIR=$BASEDIR/lib

export COMMONLOC="file://${LIBDIR}/"

export CLASSPATH=$BINDIRS:$LIBDIR/$JGRAPHFILE

Compile() {
	ant -buildfile $BASEDIR/Common/build.xml   && \
	ant -buildfile $BASEDIR/Client/build.xml   && \
	ant -buildfile $BASEDIR/Manager/build.xml  && \
	ant -buildfile $BASEDIR/Launcher/build.xml && \
	jar cvf $LIBDIR/Common.jar -C Common/bin .
}

Clean() {
	ant -buildfile $BASEDIR/Common/build.xml clean
	ant -buildfile $BASEDIR/Client/build.xml clean
	ant -buildfile $BASEDIR/Manager/build.xml clean
	ant -buildfile $BASEDIR/Launcher/build.xml clean
	rm -f $LIBDIR/Common.jar
}

RunManager() {
	echo "Running manager: codebase=${COMMONLOC} and registry=${REGISTRYLOC}"
	echo "You should have alredy run \"rmiregistry\" on machine ${REGISTRYLOC}"
	java -Djava.rmi.server.codebase=$COMMONLOC -Djava.security.policy=$BASEDIR/Manager/security.policy manager.ConcreteManager $REGISTRYLOC $BASEDIR &
}

RunLauncher() {
	echo "Running launcher: codebase=${COMMONLOC} and registry=${REGISTRYLOC}"
	java -Djava.rmi.server.codebase=$COMMONLOC -Djava.security.policy=$BASEDIR/Launcher/security.policy launcher.ConcreteLauncher $REGISTRYLOC &
}

RunClient() {
	echo "Running client: codebase=${COMMONLOC} and registry=${REGISTRYLOC}"
	java -Djava.rmi.server.codebase=$COMMONLOC -Djava.security.policy=$BASEDIR/Client/security.policy client.Client $REGISTRYLOC &
}

Kill() {
	killall rmiregistry
	ps ax | grep ConcreteManager | grep -v grep | cut -d ' ' -f 2 | xargs kill
	ps ax | grep ConcreteLauncher | grep -v grep | cut -d ' ' -f 2 | xargs kill
}

COMMAND=$1

shift

case "${COMMAND}" in
    classpath)    echo $CLASSPATH ;;
    compile)      Compile $@ ;;
    clean)        Clean $@ ;;
    manager)      RunManager $@ ;;
    launcher)     RunLauncher $@ ;;
    client)       RunClient $@ ;;
    kill)         Kill $@ ;;
    *)            echo "Unrecognized command"; exit 1; ;;
esac

exit 0
