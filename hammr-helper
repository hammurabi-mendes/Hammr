#!/bin/sh

BASEDIR=`pwd`

REGISTRYLOC=localhost

COMMONFILE="Common.jar"
JGRAPHFILE="jgrapht-jdk1.6.jar"

BINDIRS=$BASEDIR/Client/bin:$BASEDIR/Common/bin:$BASEDIR/Launcher/bin:$BASEDIR/Manager/bin
LIBDIR=$BASEDIR/lib

export CODEBASE="file://${BASEDIR}/Common/bin/"

export CLASSPATH=$BINDIRS:$LIBDIR/$JGRAPHFILE

Compile() {
	ant -buildfile $BASEDIR/Common/build.xml   && \
	ant -buildfile $BASEDIR/Client/build.xml   && \
	ant -buildfile $BASEDIR/Manager/build.xml  && \
	ant -buildfile $BASEDIR/Launcher/build.xml
}

Clean() {
	ant -buildfile $BASEDIR/Common/build.xml clean
	ant -buildfile $BASEDIR/Client/build.xml clean
	ant -buildfile $BASEDIR/Manager/build.xml clean
	ant -buildfile $BASEDIR/Launcher/build.xml clean
}

RunManager() {
	REGISTRYLOC=$1; shift;

	echo "Running manager: codebase=${CODEBASE} and registry=${REGISTRYLOC}"
	echo "You should have alredy run \"rmiregistry\" on machine ${REGISTRYLOC}"
	java -cp $CLASSPATH -Djava.rmi.server.codebase=$CODEBASE -Djava.security.policy=$BASEDIR/Manager/security.policy manager.ConcreteManager $REGISTRYLOC $BASEDIR $@ &
}

RunLauncher() {
	REGISTRYLOC=$1; shift;

	echo "Running launcher: codebase=${CODEBASE} and registry=${REGISTRYLOC}"
	java -cp $CLASSPATH -Djava.rmi.server.codebase=$CODEBASE -Djava.security.policy=$BASEDIR/Launcher/security.policy launcher.ConcreteLauncher $REGISTRYLOC $@ &
}

RunClient() {
	REGISTRYLOC=$1; shift;

	echo "Running client: codebase=${CODEBASE} and registry=${REGISTRYLOC}"
	java -cp $CLASSPATH -Djava.rmi.server.codebase=$CODEBASE -Djava.security.policy=$BASEDIR/Client/security.policy client.Client $REGISTRYLOC $@ &
}

Kill() {
	killall rmiregistry
	ps ax | grep ConcreteManager | grep -v grep | cut -d ' ' -f 2 | xargs kill
	ps ax | grep ConcreteLauncher | grep -v grep | cut -d ' ' -f 2 | xargs kill
}

COMMAND=$1; shift;

case "${COMMAND}" in
    classpath)    echo $CLASSPATH ;;
    compile)      Compile $@ ;;
    clean)        Clean $@ ;;
    manager)      RunManager $@ ;;
    launcher)     RunLauncher $@ ;;
    client)       RunClient $@ ;;
    kill)         Kill $@ ;;
    *)            echo "Unrecognized command"; exit 1; ;;
esac

exit 0
